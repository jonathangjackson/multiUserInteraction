<html>
    <head>
        <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
        <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>
        <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v5.0.1/dist/aframe-extras.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
        <script src="easyrtc/easyrtc.js"></script>
        <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>    
        <script>
            var scoreEvent = new Event('score');

            AFRAME.registerComponent('sling-shot', {
                init: function(){
                    var Context_AF = this;
                    var obj = this.el;
                    var myVar;
                    this.el.setAttribute('position', this.el.parentNode.parentNode.getAttribute('position'));
                    myVar = setInterval(function(){Context_AF.shot(Context_AF)}, 100);

                    obj.addEventListener('collide', function(e){
                        console.log("SCORE");
                        if(e.detail.body.el.getAttribute('id') === "target-collider"){
                            e.detail.body.el.parentElement.children[0].setAttribute('delete-self', {delete: 'true'});
                            e.detail.body.el.parentElement.children[1].setAttribute('delete-self', {delete: 'true'});
                        }
                    });
                },

                shot:function(obj){
                    var myVar;
                    obj.el.setAttribute('material', {color: 'blue'});
                    obj.el.removeAttribute("spring__left");
                    obj.el.removeAttribute("spring__right");
                    myVar = setInterval(function(){obj.delete(obj)}, 2000);
                },

                delete:function(obj){
                    obj.el.setAttribute('delete-self', {delete: true});
                }
            });
        
            AFRAME.registerComponent('delete-self', {
                schema:{
                    delete: {default: false}
                },
                init: function(){
                },
                tick: function(){
                    const Context_AF = this;
                    var el = this.el;
                    if(this.data.delete === true) {
                        Context_AF.deleteMyself();
                    }
                },
                deleteMyself: function(){
                    const Context_AF = this;
                    Context_AF.el.parentNode.removeChild(Context_AF.el); 
                }
            });

            AFRAME.registerComponent('game-controls',{
                schema: {
                    bulletTemplate: {default: '#bullet-template'},
                    targetTemplate: {default: '#target-template'},
                    score: {default: 0},
                    playerName: {default: "null"}
                },

                init: function () {
                    var obj = this.el;
                    var that = this;
                    let textEntity = document.createElement('a-entity');
                    this.data.playerName = this.el.getAttribute('networked').networkId;
                    
                    textEntity.setAttribute('text', {value: "Score: " + this.data.score, color: 'red', width: 10, height: 10});
                    textEntity.setAttribute('position', {x:-3, y:8, z:-10});
                    textEntity.setAttribute('id', 'timerText');
    
                    this.el.appendChild(textEntity);

                    document.body.onkeyup = function(e){
                        console.log(e.keyCode);
                        if(e.keyCode == 32){
                            that.callShot();
                        }
                        if(e.keyCode == 38){
                            var pos = obj.getAttribute('position');
                            obj.setAttribute('position', {x: pos.x, y: pos.y + 1, z: pos.z});
                        }
                        if(e.keyCode == 40){
                            var pos = obj.getAttribute('position');
                            obj.setAttribute('position', {x: pos.x, y: pos.y - 1, z: pos.z});
                        }
                        if(e.keyCode == 49){
                            that.generateTarget();
                        }
                    }
                },

                callShot: function(){
                    this.shot();
                },

                shot: function() {
                    var Context_AF = this;
                    var obj = document.createElement('a-entity');
                    var pos = document.querySelector('#player').getAttribute('position'); 
                    obj.setAttribute('position', {x: pos.x, y: pos.y, z: pos.z});
                    obj.setAttribute('networked', 'template:' + this.data.bulletTemplate);//adding networkId  
                    //console.log(pos);  
                    var scene = document.querySelector('#player');
                    scene.appendChild(obj);   
                    obj.setAttribute('id', this.data.playerName);
                    
                },

                generateTarget: function(){
                    var Context_AF = this;
                    var obj = document.createElement('a-entity');
                    var pos = document.querySelector('#player').getAttribute('position'); 
                    var rot = document.querySelector('#player').getAttribute('rotation'); 
                    obj.setAttribute('networked', 'template:' + this.data.targetTemplate);//adding networkId 
                    obj.setAttribute('position', pos);
                    obj.setAttribute('rotation', rot);
                    //console.log(pos);  
                    scene.appendChild(obj);
                    
                }
            });
        </script>
    </head>
    <body>
        <a-scene id="scene" networked-scene=" room: shooter; debug: true;" physics="debug: true; iterations: 100;"> 
            <a-assets>
                <a-asset-item id="target-obj" src="assets/objects/target.obj"></a-asset-item>
                <template id="avatar-template">
                    <a-entity class="avatar">
                        <a-sphere class="head" scale="0.45 0.5 0.4" ></a-sphere>
                    </a-entity>
                </template>
                <template id="bullet-template">
                    <a-entity class="bullet">
                        <a-sphere class="shot" dynamic-body="mass: 1" material="color: orange" spring__left="target:#left-box" spring__right="target:#right-box" sling-shot delete-self></a-sphere>
                    </a-entity>
                </template>

                <template id="target-template">
                    <a-entity class="target">
                        <a-entity class="targetClass" id="target-entity" obj-model="obj: #target-obj;" scale="0.1 0.1 0.1" rotation="0 90 0" material="color: red" delete-self></a-entity>
                        <a-box id="target-collider" static-body visible="false" delete-self></a-box>
                    </a-entity>
                </template>

            </a-assets>

            <a-sky color="#000000"></a-sky>
            
            <a-entity id="player" networked="template:#avatar-template" game-controls camera position="0 1.3 0" wasd-controls look-controls>
                <a-sphere class="head" color="#5985ff" visible="false"></a-sphere>
            </a-entity>
            <!--<a-entity id="slingshot-entity" networked="template:#box-template"></a-entity>-->
            <a-box class='cube' id='left-box' color="blue"  position="-1 2.6 -2" static-body></a-box>
            <a-box class='cube' id='right-box' color="blue"  position="3 2.6 -2" static-body></a-box>

            <a-plane static-body="shape: width" height="100" width="100" position="0 -1 0" rotation="-90 0 0" ></a-plane>
        </a-scene>
        <script>
            // Define custom schema for syncing avatar components
            NAF.schemas.add({
                template: '#bullet-template',
                components: [
                'position',
                'rotation',
                {
                    selector: '#bullet-sphere',
                    component: 'material',
                    property: 'color'
                }
                ]
            });
            
            NAF.schemas.add({
                template: '#target-template',
                components: [
                'position',
                'rotation'
                ]
            });
        </script>
    </body>
</html>